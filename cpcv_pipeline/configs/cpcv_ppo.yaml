# PPO Configuration for CPCV Pipeline HPO
# Usage:
#   Single run:  python cpcv_pipeline/hpo_cpcv.py --config-name=cpcv_ppo
#   HPO sweep:   python cpcv_pipeline/hpo_cpcv.py -m --config-name=cpcv_ppo
#
# Uses leak-free CPCV: pre-sliced .npz + dynamic env classes
# (no range flattening like hpo_alpaca_vecenv.py)

defaults:
  - _self_
  - search_space: ppo_space
  - override hydra/sweeper: HyperSMAC

# Agent
agent: ppo
gpu_id: 0

# Cross-validation — CPCV by default for PBO
# cv_method: holdout | wf | cpcv
cv_method: cpcv
n_folds: 3            # walk-forward folds (only for cv_method=wf)
n_groups: 5           # CPCV N (only for cv_method=cpcv)
n_test_groups: 2      # CPCV K → C(N,K) splits
embargo_days: 7       # embargo after test fold boundaries
gap_days: 7           # purging gap (holdout/wf only)
test_ratio: 0.2       # held-out test fraction (final OOS evaluation)

# Adaptive CPCV defaults (only used when cv_method=acpcv)
acpcv_feature: drawdown  # volatility | drawdown
acpcv_window: 63
n_subsplits: 3
lower_quantile: 0.25
upper_quantile: 0.75

# Bagged CPCV defaults (only used when cv_method=bcpcv)
n_bags: 5
base_seed: 1943

# Training
seed: 42
break_step: 500000

# Environment (fixed, not tuned)
state_dim: 283
action_dim: 28
num_envs: 2048

# Hyperparameters (defaults — overridden by search space)
learning_rate: 1e-4
gamma: 0.99
net_arch: "small"     # small=[64,64], medium=[256,128], large=[512,256]
batch_size: 512
repeat_times: 16

# PPO-specific
ratio_clip: 0.25
lambda_gae_adv: 0.95
lambda_entropy: 0.01
clip_grad_norm: 3.0
if_use_v_trace: true

# VecNormalize — env already scales obs/rewards
use_vec_normalize: false
norm_obs: true
norm_reward: false

cleanup_checkpoints: true

# Hydra sweeper
hydra:
  sweeper:
    search_space: ${search_space}
    n_trials: 50
    resume: true
    sweeper_kwargs:
      seeds: [0, 1, 2]
      max_parallelization: 1
      maximize: true
      optimizer_kwargs:
        smac_facade:
          _target_: smac.facade.hyperparameter_optimization_facade.HyperparameterOptimizationFacade
          _partial_: true
        scenario:
          n_trials: ${hydra.sweeper.n_trials}
          deterministic: false
          n_workers: 1
          output_directory: ${hydra.sweep.dir}
